<div class="container py-4">
  <h2 class="mb-4 text-center">استعراض العمليات</h2>
  <div class="row mb-3">
    <div class="col-md-4">
      <label>نوع العملية</label>
      <select class="form-select" [(ngModel)]="selectedType">
        <option *ngFor="let type of operationTypes" [value]="type.key">{{ type.label }}</option>
      </select>
    </div>
    <div class="col-md-4" *ngIf="selectedType === 'expenses' || selectedType === 'returns' || selectedType === 'disposals'  || selectedType === 'transfer'">
      <label>الوحدة</label>
      <select class="form-select" [(ngModel)]="selectedUnit">
        <option value="">كل الوحدات</option>
        <option *ngFor="let unit of units" [value]="unit.unitName">{{ unit.unitName }}</option>
      </select>
    </div>
    <div class="col-md-4" *ngIf="selectedType === 'revenues'">
      <label>نوع الإيراد</label>
      <select class="form-select" [(ngModel)]="selectedOrderType">
        <option value="">كل الأنواع</option>
        <option *ngFor="let type of orderTypes" [value]="type.value">{{ type.label }}</option>
      </select>
    </div>
  </div>

  <!-- Expenses Table -->
  <div *ngIf="selectedType === 'expenses'">
    <table class="table table-bordered table-striped text-center">
      <thead>
        <tr>
          <th>الوحدة</th>
          <th>المستلم</th>
          <th>الصنف</th>
          <th>نوع العملية</th>
          <th>رقم المستند</th>
          <th>السند</th>
          <th>التاريخ</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let e of filteredExpenses">
          <td>{{ e.unitName }}</td>
          <td>{{ e.receiver }}</td>
          <td >
            <ul class="text-end">
            <li *ngFor="let item of e.items">{{ item.itemName }} - الكمية: {{ item.quantity }}</li>
          </ul>
          </td>
          
          <td>{{ e.type }}</td>
          <td>{{ e.documentNumber || '-' }}</td>
          <td>
            <a *ngIf="e.attachment" [href]="e.attachment" target="_blank">عرض</a>
            <span *ngIf="!e.attachment">-</span>
          </td>
          <td>
            {{  e.date | date:'dd/MM/yyyy' : '-' }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- transfer Table -->
  <div *ngIf="selectedType === 'transfer'">
    <table class="table table-bordered table-striped text-center">
      <thead>
        <tr>
          <th>الوحدة</th>
          <th>اسم المُستلِّم القديم</th> <!-- ✅ العمود الجديد -->
          <th>اسم المستلم الحالي</th>
          <th>اسم الصنف</th>
          <th>الكمية</th>
          <th> التاريخ</th>
          <th>السند</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let e of filteredtransfer">
          <td>{{ e.unitName }}</td>
          <td>{{ e.oldReceiver || '-' }}</td> <!-- ✅ عرض المسلم القديم -->
          <td>{{ e.receiverName || '-' }}</td>
          <td>{{ e.itemName }}</td>
          <td>{{ e.quantity }}</td>
          <td>
            {{ e.transferDate || e.date ? (e.transferDate || e.date
            | date:'dd/MM/yyyy') : '-' }}
          </td>
          <td>
            <a *ngIf="e.file" [href]="e.file" target="_blank">عرض</a>
            <span *ngIf="!e.file">-</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Returns Table -->
  <div *ngIf="selectedType === 'returns'">
    <table class="table table-bordered table-striped text-center">
      <thead>
        <tr>
          <th>الوحدة</th>
          <th>المستلم</th>
          <th>الصنف</th>
          <th>الكمية</th>
          <th>سبب الارجاع</th>
          <th>السند</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of filteredReturns">
          <td>{{ r.unitName }}</td>
          <td>{{ r.receiverName }}</td>
          <td>{{ r.items }}</td>
          <td>{{ r.quantity }}</td>
          <td>{{ r.disposeReason || '-' }}</td>
          <td>
            <a *ngIf="r.receipt" [href]="r.receipt" target="_blank">عرض</a>
            <span *ngIf="!r.receipt">-</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Revenues Table -->
  <div *ngIf="selectedType === 'revenues'">
    <table class="table table-bordered table-striped text-center">
      <thead>
        <tr>
          <th>نوع الإيراد</th>
          <th>رقم الأمر</th>
          <th>الصنف</th>
          <th>السند</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let o of filteredOrders">
          <td>{{ o.orderTypeLabel }}</td>
          <td>{{ o.orderNumber }}</td>
          <td>
            <ul class="list-unstyled mb-0">
              <li *ngFor="let item of o.items">
                <span class="fw-bold">
                  {{ item.itemName }}<ng-container
                    *ngIf="item.stockNumber && item.stockNumber !== ''"> ({{
                    item.stockNumber }})</ng-container>
                </span>
                - الكمية: {{ item.quantity }}
              </li>
            </ul>
          <td>
            <a *ngIf="o.fileName" [href]="o.file" target="_blank">{{ o.fileName }}</a>
            <span *ngIf="!o.fileName">-</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Disposals Table -->
  <div *ngIf="selectedType === 'disposals'">
    <table class="table table-bordered table-striped text-center">
      <thead>
        <tr>
          <th>الوحدة</th>
          <th>المستلم</th>
          <th>الصنف</th>
          <th>الكمية</th>
          <th>السند</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let d of filteredDisposals">
          <td>{{ d.unitName }}</td>
          <td>{{ d.receiverName }}</td>
          <td>{{ d.items }}</td>
          <td>{{ d.quantity }}</td>
          <td>
            <a *ngIf="d.receipt" [href]="d.receipt" target="_blank">عرض</a>
            <span *ngIf="!d.receipt">-</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
